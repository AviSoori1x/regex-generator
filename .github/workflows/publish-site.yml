name: Publish Page

on:
  push:
    branches: [ master ]

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Cache Dependencies
        uses: actions/cache@v2.1.5
        with:
          key: maven-dependencies
          path: ~/.m2/repository
    
      - name: Check out
        uses: actions/checkout@v2
      - name: Set outputs
        id: vars
        run: echo "::set-output name=sha_short::$(git rev-parse --short HEAD)"

      - name: Set up JDK 8
        uses: actions/setup-java@v2
        with:
          distribution: adopt
          java-version: 8
      - name: "Clean & Package"
        run: mvn clean package --batch-mode

      # publish the generated page to github pages
      - name: Deploy Site
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages
          cname: regex-generator.olafneumann.org

      # generate and publish docker image containing the generated page
      - name: Login to DockerHub
        uses: docker/login-action@v1 
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push Docker images
        uses: docker/build-push-action@v2.5.0
        with:
          context: .
          push: true
          tags: noxone/regexgenerator:latest,noxone/regexgenerator:${{ steps.vars.outputs.sha_short }}
